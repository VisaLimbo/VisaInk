---
title: "Visalimbo"
author: "parthkhare"
date: 2022-07-05T21:13:14-05:00
categories: ["R"]
#tags: ["R Markdown", "plot", "regression"]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(collapse = TRUE)
library(data.table);library(readxl);library(ggplot2); library(countrycode)
```

### Visa wait times

Coivd lockdowns are more or less over. With almost 70% of global population [vaccinated](%22https://www.nytimes.com/interactive/2021/world/covid-vaccinations-tracker.html%22), most countries have opened their borders. But can anyone really travel ? The waiting times to get any category of visa is unimaginable long. 
The following analysis based on wait time from the [US Department of State](https://travel.state.gov/content/travel/en/us-visas/visa-information-resources/wait-times.html) illustrates this further.


### Delays in visiting visa wait time extent upto 3 years!
```{r, echo=FALSE, warning=FALSE, message=F}
# Scraped Data Stats
# --------------
scpdt_base <- read.csv('/Users/moonlight/Documents/Moonlight Projects/2022/Visa Limbo/Data/visascraped_base_mapped.csv')
scpdt_base$X <- NULL
scpdt_base <- data.table(scpdt_base)
scpdt_base$ctyname <- countrycode(scpdt_base$Country, origin = 'iso3c', destination = 'country.name')

# ------------------------
# Charts: most delayed countries
# ------------------------
# Aggregate delay by countries
scpdt_cty <- scpdt_base[,.(VisitorVisa = mean(VisitorVisa, na.rm=T),
                        Student_ExchangeVisitorVisas=mean(Student_ExchangeVisitorVisas, na.rm=T),
                        AllOtherNonimmigrantVisas=mean(AllOtherNonimmigrantVisas,na.rm=T)),
                        by = .(Country,ctyname, date)]


# ----------------------------------------
# Charts for all visa types separately
# ----------------------------------------
# Visitor Visa more than one year
ggplot(scpdt_cty[scpdt_cty$VisitorVisa>365,], aes(y=reorder(ctyname,VisitorVisa), x=VisitorVisa)) +
  geom_bar(fill='red',stat='identity') + ggtitle("US Visa Waitime: Visitor Visa > 1 year") +  
  theme_minimal() + theme(axis.text.x=element_text(angle=90,hjust=1))+ ylab('Country') +
  xlab('Waitime by country in days')

```

### The lag is consistent across all visa categories
```{r scpdt_cty, echo=FALSE, warning=FALSE}
# Charts for all visa types combined
# ----------------------------------------
# reshape data
scpct_res <- melt(scpdt_cty, measure.vars = c( "VisitorVisa","Student_ExchangeVisitorVisas",
                                               "AllOtherNonimmigrantVisas"),
                  variable.name = "Visatype", value.name = "Waittime_days")
scpct_res <- scpct_res[!is.na(scpct_res$Waittime_days),]

# Subset top countries manually
rem_cty <- c('Papua New Guinea','Micronesia (Federated States of)','Timor-Leste','Poland',
             'Burundi','Hong Kong SAR China','Brunei','Bosnia & Herzegovina','Cambodia',
             'Latvia','Angola','Eritrea','Fiji','Chad','Suriname','CuraÃ§ao','Turkmenistan',
             'Oman','Mali','Trinidad & Tobago','Senegal','Eswatini','Equatorial Guinea',
             'Gabon','Togo','Madagascar','Benin','Guatemala','Cape Verde','Sierra Leone',
             'Mauritania','Kuwait')
scpct_sub <- scpct_res[!scpct_res$ctyname %in% rem_cty,]


# CI: geom bar for all countries
ggplot(scpct_sub,aes(x=reorder(ctyname, Waittime_days, FUN=sum),y=Waittime_days/7.019)) + 
  geom_bar(stat='identity', aes(fill = Visatype)) + coord_flip() + theme_minimal() +   
  ggtitle("US Visa Waitime") +  xlab('Country') + ylab('Waitime (weeks)') + 
  facet_grid(cols = vars(Visatype)) + 
  theme(axis.text = element_text(family = "Courier", size = (6)),
        axis.text.x=element_text(size=10), legend.position="none")
```
### Average lag by different visa types
```{r scpdt_base, echo=FALSE, warning=FALSE}
# Average delay across all categories of visa: by embassies
# ----------------------------------------
scrpie <- scpdt_base[,.(Visitor = mean(VisitorVisa, na.rm=T),
                           Student_Exchange_Visitor=mean(Student_ExchangeVisitorVisas, na.rm=T),
                           Other_Nonimmigrant=mean(AllOtherNonimmigrantVisas,na.rm=T))]

scrpiedt <-  melt(scrpie, measure.vars = c( "Visitor","Student_Exchange_Visitor",
                                            "Other_Nonimmigrant"),
                  variable.name = "Visatype", value.name = "Waittime_days")

scrpiedt$prop <-  scrpiedt$Waittime_days/sum(scrpiedt$Waittime_days)
scrpiedt$prop <- scrpiedt$prop*100
scrpiedt$ypos <- cumsum(scrpiedt$prop)- 0.5*scrpiedt$prop 

# Basic piechart
ggplot(scrpiedt, aes(x="", y=prop, fill=Visatype)) +
  geom_bar(stat="identity", width=1, color="white") +  xlab('') + 
  coord_polar("y", start=0) + theme_void() +
  geom_text(aes(y=prop+3, label = paste0(round(prop,0),'%')), color = "white", size=3)
```